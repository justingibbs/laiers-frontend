{% extends "base.html" %}
{% block title %}{{ opportunity.title }} at {{ opportunity.company_name }} - Job Matching App{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<link rel="icon" href="/static/images/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/static/css/styles.css" />
<link rel="stylesheet" href="/static/css/opportunity-detail.css" />
{% endblock %}

{% block content %}
<div class="title-container">
    <div class="header-content">
        <a href="/opportunities" class="back-link">‚Üê Back to Opportunities</a>


        <h1 class="job-title">{{ opportunity.title }}</h1>
        <div class="company-name">{{ opportunity.company_name }}</div>

        <div class="job-meta">
            <div class="meta-item">
                <span>üìç</span>
                <span>{{ opportunity.location or 'Remote' }}</span>
            </div>
            <div class="meta-item">
                <span>üíº</span>
                <span>{{ opportunity.employment_type or 'Full-time' }}</span>
            </div>
            {% if opportunity.salary_range %}
            <div class="meta-item">
                <span>üí∞</span>
                <span>{{ opportunity.salary_range }}</span>
            </div>
            {% endif %}
            <div class="meta-item">
                <span>üìÖ</span>
                <span>Posted {{ opportunity.created_at.strftime('%B %d, %Y') if opportunity.created_at else 'Recently'
                    }}</span>
            </div>
        </div>
    </div>
</div>

<div class="content">
    <!-- Job Details -->
    <div class="opportunity-card">
        <h2 class="section-title">Job Description</h2>
        <div class="job-description">
            {{ opportunity.description | replace('\n', '<br>') | safe }}
        </div>

        {% if opportunity.requirements %}
        <h2 class="section-title">Requirements</h2>
        <div class="job-requirements">
            {% set requirements_lines = opportunity.requirements.split('\n') %}
            {% if requirements_lines | length > 1 %}
            <ul class="requirements-list">
                {% for line in requirements_lines %}
                {% if line.strip() %}
                <li>{{ line.strip().lstrip('*-‚Ä¢ ') }}</li>
                {% endif %}
                {% endfor %}
            </ul>
            {% else %}
            {{ opportunity.requirements | replace('\n', '<br>') | safe }}
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Application Section -->
    {% if user_profile.user_type == 'talent' %}
    {% if has_applied %}
    <!-- Already Applied -->
    <div class="application-section">
        <div class="application-result already-applied">
            <p><strong>‚úÖ Application Already Submitted</strong></p>
            <p>You've already applied to this position. We'll review your application and get back to you if there's a
                match.</p>

            <div class="opportunity-actions">
                <a href="/dashboard" class="action-button secondary-button">Return to Dashboard</a>
                <a href="/opportunities" class="action-button primary-button">Browse More Opportunities</a>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Application Form -->
    <div class="application-section">
        <div class="application-header">
            <h2 class="section-title" style="margin: 0;">Apply for This Position</h2>
            <span
                style="background-color: #d2e6f2; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem; color: #333;">
                üìù {{ opportunity.survey_questions|length }} questions
            </span>
        </div>

        <form class="survey-form" hx-post="/api/opportunities/{{ opportunity.id }}/apply"
            hx-target="#application-result" hx-swap="innerHTML" hx-indicator="#submit-button">
            {% for question in opportunity.survey_questions %}
            <div class="form-group">
                <label class="form-label" for="question_{{ loop.index0 }}">
                    {{ question.question }}
                    {% if question.required %}
                    <span class="required-indicator">*</span>
                    {% endif %}
                </label>
                <textarea id="question_{{ loop.index0 }}" name="question_{{ loop.index0 }}" class="form-input"
                    placeholder="Please provide your answer..." {% if question.required %}required{% endif
                    %}></textarea>
            </div>
            {% endfor %}
            <div class="button-container">
                <button id="submit-button" type="submit" hx-disabled-elt="this">
                    <span>Submit Application</span>
                </button>
            </div>
        </form>

        <div id="application-result"></div>
    </div>
    {% endif %}
    {% else %}
    <!-- Not a Talent User -->
    <div class="application-section">
        <div class="not-talent-message">
            <p><strong>üëî Company Portal View</strong></p>
            <p>You're viewing this as a company user. Only talent users can apply to opportunities.</p>

            <div class="opportunity-actions">
                <a href="/company/{{ opportunity.company_id }}" class="action-button primary-button">View Company
                    Page</a>
                <a href="/dashboard" class="action-button secondary-button">Return to Dashboard</a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Handle successful application submission
    document.body.addEventListener('htmx:afterSwap', function (event) {
        if (event.detail.target.id === 'application-result') {
            // Scroll to result
            event.detail.target.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Hide the form if application was successful
            const resultContent = event.detail.target.innerHTML;
            if (resultContent.includes('‚úÖ') && resultContent.includes('Successfully')) {
                const form = document.querySelector('.survey-form');
                if (form) {
                    form.style.display = 'none';
                }
            }
        }
    });

    // Handle form submission errors
    document.body.addEventListener('htmx:responseError', function (event) {
        if (event.detail.xhr.status === 422) {
            console.error('Validation error:', event.detail.xhr.response);
        }
    });
</script>
{% endblock %}